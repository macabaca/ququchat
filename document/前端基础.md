好的，没有问题。

在之前定义的后端结构基础上，我们来为前端制定一份清晰的需求和接口文档。这份文档将指导前端开发者如何与后端进行交互。

---

### **前端需求文档 (Frontend Requirements Document)**

#### **1. 核心页面与功能**

##### **1.1. 用户认证页面**
*   **注册页 (`/register`)**:
    *   **视图**: 提供“用户名”、“密码”、“确认密码”输入框和一个“注册”按钮。
    *   **逻辑**:
        *   对输入进行校验（如：不能为空，两次密码需一致）。
        *   点击注册按钮后，调用注册API。
        *   根据API返回结果，显示成功提示（例如“注册成功，请登录”）或错误信息（例如“用户名已存在”）。
        *   注册成功后，自动跳转到登录页。
*   **登录页 (`/login`)**:
    *   **视图**: 提供“用户名”、“密码”输入框和一个“登录”按钮。
    *   **逻辑**:
        *   点击登录按钮，调用登录API。
        *   登录成功后，将获取到的JWT（JSON Web Token）存储在本地（如 `localStorage`）。
        *   跳转到主聊天界面 (`/chat`)。
        *   登录失败，显示错误提示（例如“用户名或密码错误”）。

##### **1.2. 主聊天界面 (`/chat`)**
这是一个单页应用（SPA）布局，需要实现路由守卫，未登录用户访问此页面应被重定向到登录页。

*   **整体布局**:
    *   **左侧 - 列表区**: 显示当前用户的联系人列表和群组列表。
    *   **右侧 - 聊天区**: 显示当前选中对话的聊天记录和消息输入框。
*   **左侧 - 列表区**:
    *   **视图**:
        *   一个搜索框，用于查找用户或群组。
        *   一个“会话列表”，包含所有私聊和群聊。
        *   每个列表项应显示对方用户名/群聊名称，以及最新一条消息的预览和时间。
        *   当前激活的聊天窗口应高亮显示。
    *   **逻辑**:
        *   进入页面后，通过API获取会话列表。
        *   点击列表项，切换右侧的聊天窗口。
*   **右侧 - 聊天区**:
    *   **视图**:
        *   **顶部**: 显示当前聊天对象或群聊的名称。
        *   **中部 (消息记录区)**:
            *   显示聊天历史。
            *   消息应包含发送者头像/昵称、消息内容和发送时间。
            *   自己发送的消息和对方发送的消息应有明显区分（如：左右对齐、不同背景色）。
            *   如果消息是图片，应直接渲染为图片，而不是URL链接。
            *   默认自动滚动到底部，显示最新消息。
        *   **底部 (输入区)**:
            *   一个文本输入框。
            *   一个“发送”按钮，按回车键也应能发送消息。
            *   一个“图片上传”按钮（如图标）。
*   **功能逻辑**:
    *   **WebSocket连接**:
        *   页面加载后，立即使用本地存储的JWT Token建立WebSocket连接。
        *   连接需要有心跳机制和断线重连功能。
    *   **实时消息**:
        *   能通过WebSocket实时接收和发送消息。
        *   收到新消息时，将其动态添加到对应的聊天窗口，并更新左侧会话列表的预览。
    *   **发送图片**:
        *   点击图片上传按钮，弹出文件选择框。
        *   选择图片后，调用HTTP上传接口将图片发送到服务器。
        *   上传成功后，获取到图片URL。
        *   将该URL作为一条特殊的消息，通过WebSocket发送出去。

---

### **API接口文档 (API Documentation)**

本文档定义了前后端交互的HTTP和WebSocket接口规范。

**基准URL**: `http://your-domain.com/api/v1`

#### **1. HTTP API**

##### **1.1. 认证接口 (`/auth`)**

**1.1.1. 用户注册**
*   **Endpoint**: `POST /auth/register`
*   **描述**: 创建一个新用户。
*   **请求体** (`Content-Type: application/json`):
    ```json
    {
      "username": "newuser",
      "password": "your_strong_password"
    }
    ```
*   **响应**:
    *   **`201 Created`**: 成功
        ```json
        { "message": "User created successfully" }
        ```
    *   **`400 Bad Request`**: 请求体格式错误或缺少字段。
        ```json
        { "error": "Username and password are required" }
        ```
    *   **`409 Conflict`**: 用户名已被占用。
        ```json
        { "error": "Username already exists" }
        ```

**1.1.2. 用户登录**
*   **Endpoint**: `POST /auth/login`
*   **描述**: 验证用户身份并返回JWT。
*   **请求体** (`Content-Type: application/json`):
    ```json
    {
      "username": "newuser",
      "password": "your_strong_password"
    }
    ```
*   **响应**:
    *   **`200 OK`**: 成功
        ```json
        { "token": "a.jwt.token.string" }
        ```
    *   **`401 Unauthorized`**: 凭证无效。
        ```json
        { "error": "Invalid username or password" }
        ```

##### **1.2. 文件上传接口 (`/upload`)**

**1.2.1. 上传图片**
*   **Endpoint**: `POST /upload/image`
*   **认证**: **需要**。请求头需包含 `Authorization: Bearer <your_jwt_token>`。
*   **描述**: 上传一张图片并返回其可访问的URL。
*   **请求体** (`Content-Type: multipart/form-data`):
    *   表单字段名为 `image`，值为图片文件。
*   **响应**:
    *   **`201 Created`**: 成功
        ```json
        {
          "url": "http://your-domain.com/uploads/images/filename.jpg"
        }
        ```    *   **`400 Bad Request`**: 没有上传文件或文件类型不被支持。
        ```json
        { "error": "No file provided or file type is not supported" }
        ```

##### **1.3. 房间管理接口 (`/rooms`)**
*(此部分用于获取历史会话和创建新会话)*

**1.3.1. 获取用户的所有房间**
*   **Endpoint**: `GET /rooms`
*   **认证**: **需要**。
*   **描述**: 获取当前登录用户参与的所有私聊和群聊房间列表。
*   **响应**:
    *   **`200 OK`**: 成功
        ```json
        [
          {
            "id": 101,
            "name": "Project Alpha", // 群名
            "is_private": false
          },
          {
            "id": 102,
            "name": "Bob",           // 私聊，name为对方用户名
            "is_private": true
          }
        ]
        ```

#### **2. WebSocket API**

*   **连接地址**: `ws://your-domain.com/ws?token=<your_jwt_token>`
*   **描述**: 客户端通过此地址建立WebSocket长连接。Token通过查询参数进行认证。如果Token无效，服务器应拒绝连接。

##### **2.1. 消息格式**

所有通信都使用JSON格式。每个消息体都包含 `type` 和 `payload` 两个字段。
*   `type`: 字符串，表示消息的类型或意图。
*   `payload`: 对象，包含消息的具体数据。

##### **2.2. 客户端发送给服务器 (Client -> Server)**

**2.2.1. 发送消息**
*   **type**: `"send_message"`
*   **payload**:
    ```json
    {
      "room_id": 101,
      "content": "Hello everyone!", // 文本内容或图片URL
      "is_image": false           // bool, 是否为图片
    }
    ```

**2.2.2. 拉取历史消息**
*   **type**: `"fetch_history"`
*   **payload**:
    ```json
    {
      "room_id": 101,
      "page": 1,      // 用于分页
      "page_size": 20
    }
    ```

##### **2.3. 服务器推送给客户端 (Server -> Client)**

**2.3.1. 新消息通知**
*   **type**: `"new_message"`
*   **描述**: 当房间内有新消息时，服务器会向房间内所有客户端广播此消息。
*   **payload**:
    ```json
    {
      "id": 12345,
      "room_id": 101,
      "user_id": 2,
      "username": "Alice",
      "content": "Hello everyone!",
      "is_image": false,
      "created_at": "2025-10-26T12:00:00Z"
    }
    ```

**2.3.2. 历史消息响应**
*   **type**: `"message_history"`
*   **描述**: 服务器响应客户端的 `fetch_history` 请求。
*   **payload**:
    ```json
    {
      "room_id": 101,
      "messages": [
        {
          "id": 12344,
          "user_id": 3,
          "username": "Bob",
          "content": "Let's start the meeting.",
          "is_image": false,
          "created_at": "2025-10-26T11:59:00Z"
        }
        // ... more messages
      ]
    }
    ```

**2.3.3. 错误通知**
*   **type**: `"error"`
*   **描述**: 当发生错误时（如发送到不存在的房间），服务器向发送方客户端发送此消息。
*   **payload**:
    ```json
    {
      "message": "Room not found or you are not a member."
    }
    ```