# 认证模块接口说明

本文件描述当前注册、登录、刷新令牌、登出等认证相关 HTTP 接口的使用方式、请求与响应格式、错误码以及配置要点。

## 路由与约定
- 基础路由前缀：`/api`
- 统一请求/响应格式：`application/json`
- 访问令牌：使用 `JWT (HS256)`，在 `Authorization` 头以 `Bearer <accessToken>` 传递
- 刷新令牌：后端持久化保存，同时在 Web 客户端场景下以 `HttpOnly Cookie`（键名：`refresh_token`）下发

## 接口速览
- `POST /api/auth/register` 注册新用户
- `POST /api/auth/login` 登录并签发访问令牌与刷新令牌
- `POST /api/auth/refresh` 使用刷新令牌换取新访问令牌并轮换刷新令牌
- `POST /api/auth/logout` 注销当前设备（需要 `Authorization: Bearer <accessToken>`）

---

## 注册用户
- 方法与路径：`POST /api/auth/register`
- 请求体（JSON）：
  ```json
  {
    "username": "alice",
    "password": "password123",
    "email": "alice@example.com",
    "phone": "+86-18800000000"
  }
  ```
- 参数校验：
  - `username` 必填，去除首尾空格后非空
  - `password` 必填，长度至少 `6`
  - `email`、`phone` 可选
- 成功响应：`201 Created`
  ```json
  {
    "user": {"id": "uuid", "username": "alice", "status": "active"}
  }
  ```
- 失败响应：
  - `400` 请求体格式错误 → `{"error":"请求体格式错误"}`
  - `400` 用户名为空或密码不足 6 位 → `{"error":"用户名不能为空，密码至少6位"}`
  - `500` 密码哈希失败 → `{"error":"密码哈希失败"}`
  - `409` 唯一约束冲突（用户名/邮箱/手机号重复） → `{"error":"用户名或邮箱/手机号已存在"}`
  - `500` 创建用户失败（数据库错误） → `{"error":"创建用户失败"}`

## 登录
- 方法与路径：`POST /api/auth/login`
- 请求体（JSON）：
  ```json
  {"username": "alice", "password": "password123"}
  ```
- 成功响应：`200 OK`
  - JSON：
    ```json
    {
      "accessToken": "<jwt>",
      "refreshToken": "<refresh>",
      "user": {"id": "uuid", "username": "alice", "status": "active"}
    }
    ```
  - 同时设置 `HttpOnly` Cookie：`refresh_token=<refresh>`，过期时间为配置中的 `refresh_ttl`
- 失败响应：
  - `400` 请求体格式错误 → `{"error":"请求体格式错误"}`
  - `400` 用户名或密码为空 → `{"error":"用户名和密码不能为空"}`
  - `401` 用户名不存在或密码错误 → `{"error":"用户名或密码错误"}`
  - `500` 查询用户失败 → `{"error":"查询用户失败"}`
  - `500` 签发访问令牌失败 → `{"error":"签发令牌失败"}`
  - `500` 生成刷新令牌失败 → `{"error":"生成刷新令牌失败"}`
  - `500` 保存登录会话失败 → `{"error":"记录刷新令牌失败"}`

## 刷新令牌（令牌轮换）
- 方法与路径：`POST /api/auth/refresh`
- 刷新令牌读取规则：
  - 优先从请求体读取：`{"refresh_token": "..."}`
  - 若请求体未提供，则回退到 `Cookie` 中的 `refresh_token`
- 成功响应：`200 OK`
  - JSON：
    ```json
    {"accessToken": "<new-jwt>", "refreshToken": "<new-refresh>"}
    ```
  - 同步设置新的 `HttpOnly` Cookie：`refresh_token=<new-refresh>`（旧刷新令牌被吊销）
- 失败响应：
  - `400` 缺少刷新令牌 → `{"error":"缺少刷新令牌"}`
  - `401` 刷新令牌无效（未找到会话） → `{"error":"刷新令牌无效"}`
  - `500` 查询会话失败 → `{"error":"查询会话失败"}`
  - `401` 刷新令牌已失效（被吊销或已过期） → `{"error":"刷新令牌已失效"}`
  - `401` 关联用户不存在 → `{"error":"关联用户不存在"}`
  - `500` 吊销旧令牌失败 → `{"error":"吊销旧令牌失败"}`
  - `500` 签发新访问令牌失败 → `{"error":"签发新访问令牌失败"}`
  - `500` 生成新刷新令牌失败 → `{"error":"生成新刷新令牌失败"}`
  - `500` 保存新会话失败 → `{"error":"保存新刷新令牌失败"}`

## 登出当前设备
- 方法与路径：`POST /api/auth/logout`
- 认证：需要在请求头携带 `Authorization: Bearer <accessToken>`（由中间件校验 JWT）
- 刷新令牌读取规则：
  - 优先从请求体读取：`{"refresh_token": "..."}`
  - 若请求体未提供，则回退到 `Cookie` 中的 `refresh_token`
- 成功响应：`200 OK`
  ```json
  {"message": "已成功登出当前设备"}
  ```
  - 将对应会话的刷新令牌标记为吊销
  - 清除 `refresh_token` Cookie
- 失败响应：
  - `401` 缺少 Authorization 头（中间件） → `{"error":"缺少 Authorization 头"}`
  - `401` Authorization 头格式错误（中间件） → `{"error":"Authorization 头格式错误"}`
  - `401` 访问令牌已过期（中间件） → `{"error":"访问令牌已过期"}`
  - `401` 访问令牌无效（中间件） → `{"error":"访问令牌无效"}`
  - `401` 未登录（处理器未获取到用户） → `{"error":"未登录"}`
  - `400` 缺少刷新令牌 → `{"error":"缺少刷新令牌"}`
  - `404` 未找到有效会话 → `{"error":"未找到有效会话"}`
  - `500` 查询会话失败 → `{"error":"查询会话失败"}`
  - `500` 吊销会话失败 → `{"error":"吊销会话失败"}`

---

## 认证模型与中间件
- JWT 访问令牌：
  - 算法：`HS256`
  - 载荷：`user_id`、`username` 以及标准注册字段（`sub`、`exp`、`iat`）
- 刷新令牌持久化模型：`models.AuthSession`
  - 主要字段：`ID`、`UserID`、`RefreshToken (唯一索引)`、`ExpiresAt`、`RevokedAt`、`IP`、`UserAgent`、`CreatedAt`
  - 刷新接口会吊销旧令牌并创建新会话（令牌轮换）
- 鉴权中间件：`middleware.JWTAuth`
  - 从 `Authorization: Bearer <token>` 解析并校验 JWT
  - 失败返回：
    - `401` 缺少 Authorization 头 → `{"error":"缺少 Authorization 头"}`
    - `401` Authorization 头格式错误 → `{"error":"Authorization 头格式错误"}`
    - `401` 访问令牌已过期 → `{"error":"访问令牌已过期"}`
    - `401` 访问令牌无效 → `{"error":"访问令牌无效"}`
  - 成功后向上下文注入 `user_id`、`username`

## 配置说明
- 配置文件路径：`internal/config/config.yaml`
- 认证相关字段（`auth`）：
  - `jwt_secret`：JWT 签名密钥（强随机，生产必须配置）
  - `access_ttl`：访问令牌有效期（如 `15m`、`1h`）
  - `refresh_ttl`：刷新令牌有效期（如 `720h`）
  - `refresh_token_bytes`：刷新令牌随机字节长度（默认 `32`）
- 解析逻辑：`internal/config/config_auth.go` 的 `Auth.ToSettings()`
  - TTL 字符串解析为 `time.Duration`，为空或非法时回退到默认常量
  - `JWTSecret` 回退顺序：配置文件 → 环境变量 `JWT_SECRET`/`QUQUCHAT_JWT_SECRET` → 开发默认值（伴随警告日志）
- 默认常量：`internal/server/auth/constants.go`
  - `DefaultAccessTTL`、`DefaultRefreshTTL`、`DefaultRefreshTokenBytes`

## 错误码约定
- `400 Bad Request`：参数缺失或格式错误
- `401 Unauthorized`：用户名/密码错误、访问令牌过期或无效、刷新令牌失效
- `404 Not Found`：登出时未找到有效会话
- `409 Conflict`：注册时重复的用户名/邮箱/手机号
- `500 Internal Server Error`：数据库或令牌生成/保存异常

## 示例（curl）
- 注册：
  ```bash
  curl -X POST http://localhost:8080/api/auth/register \
    -H "Content-Type: application/json" \
    -d '{"username":"alice","password":"password123"}'
  ```
- 登录（保存 Cookie）：
  ```bash
  curl -c cookies.txt -X POST http://localhost:8080/api/auth/login \
    -H "Content-Type: application/json" \
    -d '{"username":"alice","password":"password123"}'
  ```
- 刷新（使用 Cookie）：
  ```bash
  curl -b cookies.txt -X POST http://localhost:8080/api/auth/refresh
  ```
- 刷新（传 body 覆盖）：
  ```bash
  curl -X POST http://localhost:8080/api/auth/refresh \
    -H "Content-Type: application/json" \
    -d '{"refresh_token":"<token-from-login>"}'
  ```
- 登出（需要访问令牌 + 可选 body 刷新令牌）：
  ```bash
  curl -b cookies.txt -X POST http://localhost:8080/api/auth/logout \
    -H "Authorization: Bearer <accessToken>"
  # 或传 body：
  curl -X POST http://localhost:8080/api/auth/logout \
    -H "Authorization: Bearer <accessToken>" \
    -H "Content-Type: application/json" \
    -d '{"refresh_token":"<token>"}'
  ```

## 安全建议
- 生产环境必须设置强随机的 `jwt_secret`，避免使用默认值
- 在启用 HTTPS 后，将 `refresh_token` Cookie 的 `secure` 参数置为 `true`，并按需设置 `SameSite`
- 刷新令牌轮换 + 会话持久化可降低令牌泄露风险；登出及时吊销会话有助于阻断已登录设备
- 建议在启动日志打印最终生效的 `access_ttl`、`refresh_ttl` 与 `refresh_token_bytes`（不要打印密钥本身，仅标注来源），便于排查配置问题

## 相关代码位置
- 入口：`cmd/main.go`
- 路由：`internal/api/router.go`
- 认证处理器：`internal/api/handler/auth_handler.go`
- 鉴权中间件：`internal/middleware/auth.go`
- 模型：`internal/models/models.go`（`AuthSession`）
- 配置解析：`internal/config/config_auth.go`、`internal/config/config.go`、`internal/config/config_db.go`
- 默认常量：`internal/server/auth/constants.go`