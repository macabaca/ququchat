好的，我们来构建一个功能更完善、更接近生产环境的聊天室项目。

在之前的基础上，我们加入以下核心功能：

1. **用户鉴权**：用户需要通过某种方式（例如 Token）登录后才能建立 WebSocket 连接。
2. **多房间/群聊**：用户可以创建或加入不同的聊天室，消息只在各自的房间内广播。
3. **私聊**：用户可以向指定在线用户发送一对一消息。
4. **在线用户列表**：客户端可以获取当前房间或全站的在线用户。
5. **系统通知**：用户加入/离开房间时，向房间内广播系统消息。

---

### 🌟 升级后的项目框架和技术栈

| 组件            | 技术/库                           | 作用                                    |
|:------------- |:------------------------------ |:------------------------------------- |
| **Web 框架**    | Gin                            | 处理 HTTP API (如登录、创建房间) 和 WebSocket 握手 |
| **WebSocket** | `github.com/gorilla/websocket` | WebSocket 核心协议实现                      |
| **鉴权**        | JWT (JSON Web Tokens)          | 生成和验证用户身份令牌                           |
| **数据持久化**     | GORM + SQLite/MySQL (可选)       | （可选）用于存储用户信息、聊天记录                     |
| **配置管理**      | Viper (可选)                     | （可选）管理应用配置                            |

---

### 📂 全新的项目文件结构

这个结构将业务逻辑更清晰地分离，可扩展性更强。

```
advanced-chat-app/
├── main.go                       # 项目入口
├── go.mod
├── config/                       # 配置管理
│   └── config.go
├── api/                          # Gin 的 HTTP Handler
│   ├── user_handler.go           # 用户登录、注册等
│   └── ws_handler.go             # WebSocket 连接处理
├── internal/
│   └── chat/                     # 核心聊天业务
│       ├── client.go             # 客户端连接抽象
│       ├── hub.go                # 中央 Hub，负责路由和管理
│       ├── room.go               # 房间/群组的抽象
│       └── message.go            # 消息结构体
├── models/                       # 数据模型
│   └── user.go
├── middleware/                   # Gin 中间件
│   └── auth.go                   # JWT 鉴权中间件
└── auth/                         # 鉴权逻辑
    └── jwt.go                    # JWT 生成和解析
```

---

### 🧩 核心类/结构体重新设计

之前的 `Hub` 过于简单，现在它将升级为**中央路由器**，而新增的 `Room` 结构体将负责特定群组的消息广播。

#### 1. `internal/chat/message.go` - 消息体 (Message)

消息体需要扩展，以支持路由功能。

| 字段          | 类型           | 作用                                                     |
|:----------- |:------------ |:------------------------------------------------------ |
| `Type`      | `string`     | 消息类型：`"group"` (群聊), `"private"` (私聊), `"system"` (系统) |
| `Content`   | `string`     | 消息内容                                                   |
| `Sender`    | `SenderInfo` | 发送者信息 (如 UserID, Username)                             |
| `RoomID`    | `string`     | **目标房间 ID** (群聊时使用)                                    |
| `TargetID`  | `string`     | **目标用户 ID** (私聊时使用)                                    |
| `Timestamp` | `int64`      | 时间戳                                                    |

#### 2. `internal/chat/client.go` - 客户端 (Client)

Client 结构体需要知道自己属于哪个用户，以及加入了哪些房间。

| 字段         | 类型                | 作用                              |
|:---------- |:----------------- |:------------------------------- |
| `ID`       | `string`          | 用户的唯一标识 (UserID)                |
| `Username` | `string`          | 用户昵称                            |
| `hub`      | `*Hub`            | 指向中央 Hub                        |
| `conn`     | `*websocket.Conn` | WebSocket 连接                    |
| `send`     | `chan []byte`     | 发送消息的通道                         |
| `rooms`    | `map[string]bool` | **该客户端已加入的房间列表** (Key 为 RoomID) |

#### 3. `internal/chat/room.go` - 房间 (Room) - 新增

这是管理群聊的核心。每个房间都是一个小型的广播中心。

| 字段           | 类型                 | 作用             |
|:------------ |:------------------ |:-------------- |
| `ID`         | `string`           | 房间的唯一标识        |
| `Name`       | `string`           | 房间名称           |
| `clients`    | `map[*Client]bool` | **此房间内的所有客户端** |
| `register`   | `chan *Client`     | 客户端加入房间的通道     |
| `unregister` | `chan *Client`     | 客户端离开房间的通道     |
| `broadcast`  | `chan []byte`      | 房间内的消息广播通道     |

**核心方法：**

* `Run()`: 为每个房间启动一个独立的 Goroutine，监听并处理加入、离开和广播事件。

#### 4. `internal/chat/hub.go` - 中央枢纽 (Hub)

Hub 不再直接广播消息，而是扮演**注册中心**和**消息路由器**的角色。

| 字段             | 类型                   | 作用                                            |
|:-------------- |:-------------------- |:--------------------------------------------- |
| `clients`      | `map[string]*Client` | **全站所有在线客户端** (Key: UserID, Value: Client 实例) |
| `rooms`        | `map[string]*Room`   | **所有已创建的房间** (Key: RoomID, Value: Room 实例)    |
| `register`     | `chan *Client`       | 客户端注册（上线）通道                                   |
| `unregister`   | `chan *Client`       | 客户端注销（下线）通道                                   |
| `routeMessage` | `chan *Message`      | **消息路由通道**，所有消息先发到这里进行分发                      |

---

### ⚙️ 核心工作流程

#### 1. 用户登录与鉴权

1. **HTTP API 登录**: 客户端向 `/api/v1/login` 发送 POST 请求（含用户名、密码）。
2. **验证与签发 Token**: `user_handler.go` 中的 `Login` 函数验证用户信息，成功后调用 `auth/jwt.go` 生成一个 JWT。
3. **返回 Token**: 将 JWT 返回给客户端。

#### 2. WebSocket 连接建立

1. **携带 Token 连接**: 客户端在发起 `/ws` 连接请求时，在 Header 或 URL 参数中带上 JWT。
2. **JWT 中间件验证**: `middleware/auth.go` 中的鉴权中间件会拦截此请求，验证 JWT 的合法性。
3. **用户信息传递**: 验证通过后，中间件从 JWT 中解析出 `UserID` 和 `Username`，并将其存入 Gin 的 `Context` 中。
4. **升级连接**: `api/ws_handler.go` 处理请求，将 HTTP 升级为 WebSocket。
5. **创建与注册 Client**:
   * 从 Gin Context 中获取用户信息，创建一个 `Client` 实例。
   * 将此 Client 发送到 `hub.register` 通道，Hub 将其记录到全局 `clients` 映射中。
   * 为 Client 启动 `readPump` 和 `writePump` 两个 Goroutine。

#### 3. 消息路由流程

1. **客户端发送消息**: 客户端将 `Message` 结构体（包含 `Type`, `RoomID` 或 `TargetID` 等）序列化为 JSON 字符串后发送。

2. **`readPump` 读取**: `client.readPump()` 读到消息，反序列化后发送到**中央 Hub 的 `routeMessage` 通道**。

3. **Hub 路由决策**: `hub.Run()` 的主循环从 `routeMessage` 通道接收到消息，并进行判断：
   
   * **如果是群聊消息 (`Type: "group"`)**:
     * Hub 根据消息的 `RoomID` 从 `hub.rooms` 中找到对应的 `Room` 实例。
     * Hub 将消息转发到该 `room.broadcast` 通道。
     * `room.Run()` 循环接收到消息，并将其广播给该房间内的所有客户端。
   * **如果是私聊消息 (`Type: "private"`)**:
     * Hub 根据消息的 `TargetID` 从 `hub.clients` 中找到目标 `Client` 实例。
     * Hub 直接将消息写入目标 `client.send` 通道，实现一对一发送。

这个架构将不同职责清晰地划分开，使得添加新功能（如聊天记录存储、黑名单、禁言等）变得更加容易。
