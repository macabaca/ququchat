# 数据表结构与模型说明

本文档基于 `internal/models/models.go`，整理当前系统的数据模型、字段、索引与关系约定，便于数据库设计与迁移实现。

## 设计约定
- 主键：统一使用字符串 UUID（`char(36)`）作为主键。
- 字符集：建议使用 `utf8mb4`，便于处理全量 Emoji 与多语言文本。
- 软删除：部分模型使用 GORM 的 `DeletedAt`，对应表需支持软删除索引。
- 关系约束：外键统一使用 `ON DELETE CASCADE`（除非特殊说明），以简化数据清理；个别关系使用 `SET NULL`。
- 时间字段：`CreatedAt`/`UpdatedAt`/`ExpiresAt`/`RevokedAt` 等遵循命名一致性。

---

## Users（用户）
- 主键：`ID char(36)`
- 字段：
  - `Username varchar(64) not null unique` 用户名
  - `Email varchar(255) unique` 邮箱（可选）
  - `Phone varchar(32) unique` 手机（可选）
  - `PasswordHash varchar(255) not null` 密码哈希（不通过 API 返回）
  - `Status varchar(16) not null default 'active'` 用户状态
  - `DisplayName varchar(64)` 显示名称（可选）
  - `AvatarURL varchar(512)` 头像 URL（可选）
  - `Bio varchar(1024)` 个人简介（可选）
  - `CreatedAt datetime not null`
  - `UpdatedAt datetime not null`
- 索引与约束：
  - 唯一索引：`username`、`email`、`phone`

## AuthSession（登录会话/刷新令牌）
- 主键：`ID char(36)`
- 字段：
  - `UserID char(36) not null index`
  - `RefreshToken varchar(255) unique` 刷新令牌（Base64 URL 编码）
  - `ExpiresAt datetime not null` 刷新令牌过期时间
  - `RevokedAt datetime` 刷新令牌吊销时间（令牌轮换/登出设置）
  - `IP varchar(64)` 登录 IP（可选）
  - `UserAgent varchar(256)` UA（可选）
  - `CreatedAt datetime not null`
- 关系：
  - `UserID → Users(ID)`，`ON DELETE CASCADE`
- 说明：若使用 JWT 作为访问令牌，仅持久化刷新令牌以支持轮换与吊销。

## FriendRequest（好友请求）
- 主键：`ID char(36)`
- 字段：
  - `FromUserID char(36) not null`
  - `ToUserID char(36) not null`
  - `Status varchar(16) not null` 枚举：`pending`/`accepted`/`rejected`/`canceled`
  - `Message varchar(512)` 请求备注（可选）
  - `CreatedAt datetime not null`
  - `RespondedAt datetime` 响应时间（可选）
- 索引与约束：
  - 组合唯一索引（三列）：`(FromUserID, ToUserID, Status)` 名称：`uidx_friend_req_triple`
- 关系：
  - `FromUserID → Users(ID)`，`ON DELETE CASCADE`
  - `ToUserID → Users(ID)`，`ON DELETE CASCADE`

## Friendship（好友关系，无向边）
- 主键：`ID char(36)`
- 字段：
  - `UserIDA char(36) not null`
  - `UserIDB char(36) not null`
  - `CreatedAt datetime not null`
- 索引与约束：
  - 组合唯一索引：`(UserIDA, UserIDB)` 名称：`uidx_friend_pair`
  - 业务约束：建议在应用或迁移层确保 `UserIDA < UserIDB`，避免重复与方向歧义。
- 关系：
  - `UserIDA → Users(ID)`，`ON DELETE CASCADE`
  - `UserIDB → Users(ID)`，`ON DELETE CASCADE`

## Block（拉黑关系）
- 主键：`ID char(36)`
- 字段：
  - `UserID char(36) not null`
  - `BlockedUserID char(36) not null`
  - `CreatedAt datetime not null`
- 索引与约束：
  - 组合唯一索引：`(UserID, BlockedUserID)` 名称：`uidx_block_pair`
- 关系：
  - `UserID → Users(ID)`，`ON DELETE CASCADE`
  - `BlockedUserID → Users(ID)`，`ON DELETE CASCADE`

## Room（房间）
- 主键：`ID char(36)`
- 字段：
  - `RoomType varchar(16) not null index` 枚举：`group`/`direct`
  - `Name varchar(128) not null`
  - `OwnerUserID char(36) not null index`
  - `DeletedAt datetime` 软删除
  - `CreatedAt datetime not null`
  - `UpdatedAt datetime not null`
- 关系：
  - `OwnerUserID → Users(ID)`，`ON DELETE CASCADE`

## RoomMember（房间成员）
- 复合主键：`(RoomID, UserID)`
- 字段：
  - `RoomID char(36)`
  - `UserID char(36)`
  - `Role varchar(16) not null default 'member'` 枚举：`owner`/`admin`/`member`
  - `JoinedAt datetime not null`
  - `LeftAt datetime`
  - `InviteBy char(36)` 邀请人（可选）
  - `MuteUntil datetime` 禁言到期时间（可选）
  - `NicknameInRoom varchar(64)` 房间内昵称（可选）
- 关系：
  - `RoomID → Room(ID)`，`ON DELETE CASCADE`
  - `UserID → Users(ID)`，`ON DELETE CASCADE`

## Message（消息）
- 主键：`ID char(36)`
- 字段：
  - `RoomID char(36) not null index`
  - `SenderID char(36) index` 可为 `NULL`（系统消息）
  - `ContentType varchar(16) not null` 枚举：`text`/`image`/`file`/`system`
  - `ContentText text` 文本内容（可选）
  - `PayloadJSON json` 结构化负载（可选）
  - `AttachmentID char(36)` 关联附件（可选）
  - `ParentMessageID char(36) index` 引用父消息（可选）
  - `CreatedAt datetime not null`
  - `UpdatedAt datetime`
  - `DeletedAt datetime` 软删除
- 关系：
  - `RoomID → Room(ID)`，`ON DELETE CASCADE`
  - `SenderID → Users(ID)`，`ON DELETE SET NULL`
  - `AttachmentID → Attachment(ID)`（建议）
  - `ParentMessageID → Message(ID)`（建议）

## MessageReceipt（送达/已读回执）
- 复合主键：`(MessageID, UserID)`
- 字段：
  - `MessageID char(36)`
  - `UserID char(36)`
  - `DeliveredAt datetime`
  - `ReadAt datetime`
- 关系：
  - `MessageID → Message(ID)`，`ON DELETE CASCADE`
  - `UserID → Users(ID)`，`ON DELETE CASCADE`

## MessageReaction（消息表情）
- 无主键字段声明（可按需添加自增或 UUID），使用唯一约束保障幂等
- 字段：
  - `MessageID char(36) not null`
  - `UserID char(36) not null`
  - `Emoji varchar(32) not null`
  - `CreatedAt datetime not null`
- 索引与约束：
  - 组合唯一索引：`(MessageID, UserID, Emoji)` 名称：`uidx_msg_reaction`
- 关系：
  - `MessageID → Message(ID)`，`ON DELETE CASCADE`
  - `UserID → Users(ID)`，`ON DELETE CASCADE`

## Attachment（附件元数据）
- 主键：`ID char(36)`
- 字段：
  - `UploaderUserID char(36) index`
  - `URL varchar(512)`
  - `StorageKey varchar(512)`
  - `MimeType varchar(128)`
  - `SizeBytes bigint`
  - `Hash varchar(128)`
  - `StorageProvider varchar(64)`
  - `CreatedAt datetime not null`
- 关系：
  - `UploaderUserID → Users(ID)`，`ON DELETE SET NULL`

---

## 迁移与实现建议
- 外键与索引名称：建议在迁移中显式命名，保持与模型中的注释一致（如 `uidx_friend_req_triple`、`uidx_friend_pair`、`uidx_block_pair`、`uidx_msg_reaction`）。
- 软删除支持：为 `DeletedAt` 字段建立索引；查询层注意过滤软删除记录。
- 性能优化：
  - 为高频查询的外键列建立索引（如 `AuthSession.UserID`、`Message.RoomID`、`RoomMember.RoomID/UserID`）。
  - 大文本字段（如消息文本）与 JSON 负载可按需拆表，避免热点行过大。
- 无向好友关系：在应用层确保 `(UserIDA, UserIDB)` 的顺序（如按字符串比较），或在迁移中添加 CHECK 约束以防止重复与自引用。

## 备注
- 所有时间类型以数据库原生 `DATETIME/TIMESTAMP` 存储；如需时区支持，建议统一 UTC 并在应用层转换。
- 若迁移目标为 Postgres，可考虑使用 `uuid` 原生类型与部分唯一索引（如 `FriendRequest` 的 `status='pending'` 唯一）。